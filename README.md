# OpenShift Restricted Network Infrastructure on AWS

This Terraform project creates the necessary infrastructure for deploying OpenShift in a restricted network environment on AWS. It sets up a VPC with public and private subnets, along with two EC2 instances:

1. A bastion host in the public subnet
2. A mirror host in the private subnet

## Prerequisites

- AWS CLI configured with appropriate credentials
- Terraform installed (version >= 1.0.0)
- RHEL 9 AMI ID for your AWS region

## Infrastructure Components

- VPC with CIDR block 10.0.0.0/16
- 3 public subnets across different availability zones
- 3 private subnets across different availability zones
- Internet Gateway for public subnet access
- NAT Gateway for private subnet internet access
- Security groups for bastion and mirror hosts
- EC2 instances:
  - Bastion host (t3.medium, 50GB disk)
  - Mirror host (t3.xlarge, 1000GB disk)
- SSH key pair for instance access

## Usage

1. Update the `variables.tf` file with your desired values, especially the `rhel9_ami_id` variable.

2. Initialize Terraform:
   ```bash
   terraform init
   ```

3. Review the planned changes:
   ```bash
   terraform plan
   ```

4. Apply the configuration:
   ```bash
   terraform apply
   ```

5. After applying, Terraform will output:
   - VPC ID
   - Public and private subnet IDs
   - Bastion host public IP
   - Mirror host private IP
   - SSH key name and path

## Accessing the Instances

- The bastion host is accessible via SSH from anywhere (0.0.0.0/0)
- The mirror host is only accessible from the bastion host
- Both instances have the following tools pre-installed:
  - vim
  - jq
  - oc (OpenShift CLI)
  - mirror-registry
  - oc-mirror
  - wget

### SSH Access

A new SSH key pair will be generated and saved locally. The private key will be saved as `<environment>-key.pem` in the project directory. To connect to the instances:

1. Set the correct permissions for the private key:
   ```bash
   chmod 600 <environment>-key.pem
   ```

2. Connect to the bastion host:
   ```bash
   ssh -i <environment>-key.pem ec2-user@<bastion_public_ip>
   ```

3. From the bastion host, connect to the mirror host:
   ```bash
   ssh -i <environment>-key.pem ec2-user@<mirror_private_ip>
   ```

## OpenShift Mirroring Process

After setting up the infrastructure, follow these steps to create a mirror registry and prepare for OpenShift installation:

### On the Mirror Host

1. Install the Mirror Registry:
   ```bash
   ./mirror-registry install --quayHostname <hostname fqdn> \
   --quayRoot /root/ocpmirror
   ```

2. Verify Mirror Registry Access:
   ```bash
   export SSL_CERT_DIR=/root/ocpmirror/quay-rootCA/
   podman login -u init -p <password generated by installer> \
   https://<hostname fqdn>:8443
   ```

3. Set up Pull Secret:
   - Download your OpenShift pull secret from https://console.redhat.com/openshift/downloads
   - Save it as `pull-secret`
   - Process the pull secret:
     ```bash
     cat pull-secret | jq . > pull-secret.json
     mkdir .docker
     cp pull-secret.json .docker/config.json
     echo -n 'init:<password from mirror-registry>' | base64 -w0
     ```

4. Configure Image Set:
   - Copy the contents of `config/imageset-config.yaml` to `/home/ec2-user/`
   - Make necessary modifications to the configuration

5. Mirror to Disk:
   ```bash
   /usr/local/bin/oc-mirror --config=imageset-config.yaml file://home/ec2-user/mirror --v2 --authfile=.docker/config.json
   ```

6. Mirror to Registry:
   ```bash
   /usr/local/bin/oc-mirror --config=imageset-config.yaml --from=file://home/ec2-user/mirror docker://<mirror-public-dns>:8443 --v2 --authfile=.docker/config.json
   ```

7. Verify the mirroring process:
   - Check for generated YAML files for ImageDigestMirrorSet, ImageTagMirrorSet, and CatalogSource resources

### On the Bastion Host

1. Create a directory for OpenShift installation:
   ```bash
   mkdir disconnected-ocp
   ```

2. Copy and modify the install configuration:
   - Copy `config/install-config.yaml` to the disconnected-ocp directory
   - Update the configuration with:
     - SSH key
     - Pull secret for the mirror registry
     - Subnet information
     - Cluster name
     - Other required parameters

3. Create the OpenShift cluster:
   ```bash
   openshift-install create cluster
   ```

## Cleanup

To destroy all created resources:
```bash
terraform destroy
```

## References

- [About oc-mirror plugin v2](https://docs.redhat.com/en/documentation/openshift_container_platform/4.16/html/disconnected_installation_mirroring/about-installing-oc-mirror-v2)
- [Installing OpenShift Container Platform in a restricted network on AWS](https://docs.redhat.com/en/documentation/openshift_container_platform/4.15/html/installing_on_aws/installing-restricted-networks-aws-installer-provisioned)
- [Installing and mirroring in a disconnected environment](https://docs.redhat.com/en/documentation/openshift_container_platform/4.16/html/disconnected_installation_mirroring/installing-mirroring-disconnected)
- [Red Hat OpenShift Disconnected Installations](https://www.redhat.com/en/blog/red-hat-openshift-disconnected-installations)

## Notes

- The bastion host is used to access the mirror host
- All necessary tools are installed via user data scripts
- Security groups are configured to allow necessary traffic between instances
- The SSH key pair is automatically generated and saved locally 